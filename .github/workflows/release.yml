name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  id-token: write
  packages: write
  attestations: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================================================
  # Pre-Release Validation
  # ============================================================================
  validate:
    name: Pre-Release Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - uses: Swatinem/rust-cache@v2

      - name: Validate tag format
        run: |
          TAG="${{ github.ref_name }}"
          if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "Invalid tag format: $TAG"
            echo "Expected format: vX.Y.Z or vX.Y.Z-suffix"
            exit 1
          fi
          echo "Tag format valid: $TAG"

      - name: Validate version matches Cargo.toml
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#v}"
          CARGO_VERSION=$(grep '^version' Cargo.toml | head -1 | cut -d'"' -f2)
          if [ "$VERSION" != "$CARGO_VERSION" ]; then
            echo "Tag version ($VERSION) doesn't match Cargo.toml ($CARGO_VERSION)"
            exit 1
          fi
          echo "Version validated: $VERSION"

      - name: Run tests
        run: cargo test --all-features

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  # ============================================================================
  # Build Source Distribution
  # ============================================================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: validate
    outputs:
      hashes: ${{ steps.hash.outputs.hashes }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Package crate
        run: cargo package --allow-dirty

      - name: Create source archive
        run: |
          VERSION="${{ github.ref_name }}"
          ARCHIVE="physjitter-${VERSION}-source.tar.gz"
          tar -czvf "$ARCHIVE" \
            --exclude='.git' \
            --exclude='target' \
            --exclude='*.tar.gz' \
            .
          echo "ARCHIVE=$ARCHIVE" >> $GITHUB_ENV

      - name: Generate hash
        id: hash
        run: |
          sha256sum "${{ env.ARCHIVE }}" | base64 -w0 > hash.txt
          echo "hashes=$(cat hash.txt)" >> "$GITHUB_OUTPUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: source
          path: ${{ env.ARCHIVE }}
          retention-days: 7

      - name: Attest Build Provenance
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: ${{ env.ARCHIVE }}

  # ============================================================================
  # SLSA Provenance Generation (Level 3)
  # ============================================================================
  slsa-provenance:
    name: SLSA Provenance
    needs: build
    permissions:
      actions: read
      id-token: write
      contents: write
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.1.0
    with:
      base64-subjects: "${{ needs.build.outputs.hashes }}"
      upload-assets: true

  # ============================================================================
  # Generate SBOM
  # ============================================================================
  sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4

      - name: Install Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Generate SPDX SBOM
        run: |
          syft dir:. -o spdx-json=physjitter-sbom.spdx.json

      - name: Generate CycloneDX SBOM
        run: |
          syft dir:. -o cyclonedx-json=physjitter-sbom.cdx.json

      - name: Upload SBOMs
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: |
            physjitter-sbom.spdx.json
            physjitter-sbom.cdx.json

  # ============================================================================
  # Create GitHub Release
  # ============================================================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build, slsa-provenance, sbom]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Generate checksums
        run: |
          cd artifacts
          sha256sum *.tar.gz 2>/dev/null > checksums.txt || true
          cat checksums.txt

      - name: Get previous tag
        id: prev_tag
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          if [ -n "${{ steps.prev_tag.outputs.prev_tag }}" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s" ${{ steps.prev_tag.outputs.prev_tag }}..HEAD)
          else
            CHANGELOG="Initial release"
          fi
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: physjitter ${{ github.ref_name }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          files: |
            artifacts/*.tar.gz
            artifacts/checksums.txt
            artifacts/physjitter-sbom.spdx.json
            artifacts/physjitter-sbom.cdx.json
          body: |
            ## physjitter ${{ github.ref_name }}

            Proof-of-process primitive using timing jitter for human authorship verification.

            ### Installation

            ```toml
            [dependencies]
            physjitter = "${{ github.ref_name }}"
            ```

            Or via cargo:
            ```bash
            cargo add physjitter@${{ github.ref_name }}
            ```

            ### Verification

            All release artifacts include:
            - SHA256 checksums (`checksums.txt`)
            - SLSA Level 3 provenance attestations
            - SBOM (SPDX and CycloneDX formats)

            ```bash
            # Verify SLSA provenance
            slsa-verifier verify-artifact physjitter-${{ github.ref_name }}-source.tar.gz \
              --provenance-path multiple.intoto.jsonl \
              --source-uri github.com/writerslogic/physjitter
            ```

            ### Changelog
            ${{ steps.changelog.outputs.changelog }}

            ---
            **Full Changelog**: https://github.com/writerslogic/physjitter/compare/${{ steps.prev_tag.outputs.prev_tag }}...${{ github.ref_name }}

  # ============================================================================
  # Publish to crates.io
  # ============================================================================
  publish:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    needs: release
    environment: crates-io
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Publish to crates.io
        run: cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
